{"ast":null,"code":"import _asyncToGenerator from \"@babel/runtime/helpers/asyncToGenerator\";\nimport _toConsumableArray from \"@babel/runtime/helpers/toConsumableArray\";\nimport _slicedToArray from \"@babel/runtime/helpers/slicedToArray\";\nimport _regeneratorRuntime from \"@babel/runtime/regenerator\";\nimport React, { useState, useEffect, useRef } from 'react';\nimport './Login.css';\nvar MFAStep = function MFAStep(_ref) {\n  var username = _ref.username,\n    mfaToken = _ref.mfaToken,\n    onSuccess = _ref.onSuccess,\n    onCancel = _ref.onCancel;\n  var _useState = useState(['', '', '', '', '', '']),\n    _useState2 = _slicedToArray(_useState, 2),\n    code = _useState2[0],\n    setCode = _useState2[1];\n  var _useState3 = useState(false),\n    _useState4 = _slicedToArray(_useState3, 2),\n    isLoading = _useState4[0],\n    setIsLoading = _useState4[1];\n  var _useState5 = useState(''),\n    _useState6 = _slicedToArray(_useState5, 2),\n    error = _useState6[0],\n    setError = _useState6[1];\n  var _useState7 = useState(300),\n    _useState8 = _slicedToArray(_useState7, 2),\n    timer = _useState8[0],\n    setTimer = _useState8[1]; // 5 minutos\n  var inputRefs = useRef([]);\n  useEffect(function () {\n    // Auto-focus en el primer input\n    if (inputRefs.current[0]) {\n      inputRefs.current[0].focus();\n    }\n\n    // Timer para expiración del código MFA\n    var interval = setInterval(function () {\n      setTimer(function (prev) {\n        if (prev <= 1) {\n          clearInterval(interval);\n          setError('El código ha expirado. Por favor, solicita uno nuevo.');\n          return 0;\n        }\n        return prev - 1;\n      });\n    }, 1000);\n    return function () {\n      return clearInterval(interval);\n    };\n  }, []);\n  var formatTime = function formatTime(seconds) {\n    var mins = Math.floor(seconds / 60);\n    var secs = seconds % 60;\n    return \"\".concat(mins, \":\").concat(secs.toString().padStart(2, '0'));\n  };\n  var handleInputChange = function handleInputChange(index, value) {\n    // Solo permitir números\n    if (value && !/^\\d$/.test(value)) {\n      return;\n    }\n    var newCode = _toConsumableArray(code);\n    newCode[index] = value;\n    setCode(newCode);\n    setError('');\n\n    // Auto-focus en el siguiente input\n    if (value && index < 5) {\n      var _inputRefs$current;\n      (_inputRefs$current = inputRefs.current[index + 1]) === null || _inputRefs$current === void 0 || _inputRefs$current.focus();\n    }\n\n    // Si se llenó el código, verificar automáticamente\n    if (newCode.every(function (digit) {\n      return digit !== '';\n    }) && newCode.length === 6) {\n      handleVerifyCode(newCode.join(''));\n    }\n  };\n  var handleKeyDown = function handleKeyDown(index, e) {\n    // Manejar backspace\n    if (e.key === 'Backspace' && !code[index] && index > 0) {\n      var _inputRefs$current2;\n      (_inputRefs$current2 = inputRefs.current[index - 1]) === null || _inputRefs$current2 === void 0 || _inputRefs$current2.focus();\n    }\n  };\n  var handlePaste = function handlePaste(e) {\n    e.preventDefault();\n    var pastedData = e.clipboardData.getData('text').trim();\n    if (/^\\d{6}$/.test(pastedData)) {\n      var _inputRefs$current$;\n      var digits = pastedData.split('');\n      setCode(digits);\n      (_inputRefs$current$ = inputRefs.current[5]) === null || _inputRefs$current$ === void 0 || _inputRefs$current$.focus();\n      handleVerifyCode(pastedData);\n    }\n  };\n  var handleVerifyCode = /*#__PURE__*/function () {\n    var _ref2 = _asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(codeToVerify) {\n      var response, data, _inputRefs$current$2, _inputRefs$current$3, _t;\n      return _regeneratorRuntime.wrap(function (_context) {\n        while (1) switch (_context.prev = _context.next) {\n          case 0:\n            setIsLoading(true);\n            setError('');\n            _context.prev = 1;\n            _context.next = 2;\n            return fetch('/api/auth/verify-mfa', {\n              method: 'POST',\n              headers: {\n                'Content-Type': 'application/json'\n              },\n              body: JSON.stringify({\n                mfaToken: mfaToken,\n                code: codeToVerify\n              })\n            });\n          case 2:\n            response = _context.sent;\n            if (response.ok) {\n              _context.next = 3;\n              break;\n            }\n            throw new Error('Código inválido');\n          case 3:\n            _context.next = 4;\n            return response.json();\n          case 4:\n            data = _context.sent;\n            if (data.success) {\n              // Guardar token de sesión\n              sessionStorage.setItem('authToken', data.token);\n              onSuccess();\n            } else {\n              setError(data.error || 'Código inválido');\n              setCode(['', '', '', '', '', '']);\n              (_inputRefs$current$2 = inputRefs.current[0]) === null || _inputRefs$current$2 === void 0 || _inputRefs$current$2.focus();\n            }\n            _context.next = 6;\n            break;\n          case 5:\n            _context.prev = 5;\n            _t = _context[\"catch\"](1);\n            setError('Error al verificar el código. Por favor, intenta de nuevo.');\n            setCode(['', '', '', '', '', '']);\n            (_inputRefs$current$3 = inputRefs.current[0]) === null || _inputRefs$current$3 === void 0 || _inputRefs$current$3.focus();\n          case 6:\n            _context.prev = 6;\n            setIsLoading(false);\n            return _context.finish(6);\n          case 7:\n          case \"end\":\n            return _context.stop();\n        }\n      }, _callee, null, [[1, 5, 6, 7]]);\n    }));\n    return function handleVerifyCode(_x) {\n      return _ref2.apply(this, arguments);\n    };\n  }();\n  var handleResendCode = /*#__PURE__*/function () {\n    var _ref3 = _asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2() {\n      var response, _inputRefs$current$4, _t2;\n      return _regeneratorRuntime.wrap(function (_context2) {\n        while (1) switch (_context2.prev = _context2.next) {\n          case 0:\n            setIsLoading(true);\n            setError('');\n            _context2.prev = 1;\n            _context2.next = 2;\n            return fetch('/api/auth/resend-mfa', {\n              method: 'POST',\n              headers: {\n                'Content-Type': 'application/json'\n              },\n              body: JSON.stringify({\n                mfaToken: mfaToken\n              })\n            });\n          case 2:\n            response = _context2.sent;\n            if (response.ok) {\n              setTimer(300); // Reiniciar timer\n              setCode(['', '', '', '', '', '']);\n              (_inputRefs$current$4 = inputRefs.current[0]) === null || _inputRefs$current$4 === void 0 || _inputRefs$current$4.focus();\n              alert('Código reenviado. Revisa tu aplicación de autenticación.');\n            } else {\n              setError('Error al reenviar el código. Por favor, intenta de nuevo.');\n            }\n            _context2.next = 4;\n            break;\n          case 3:\n            _context2.prev = 3;\n            _t2 = _context2[\"catch\"](1);\n            setError('Error al reenviar el código. Por favor, intenta de nuevo.');\n          case 4:\n            _context2.prev = 4;\n            setIsLoading(false);\n            return _context2.finish(4);\n          case 5:\n          case \"end\":\n            return _context2.stop();\n        }\n      }, _callee2, null, [[1, 3, 4, 5]]);\n    }));\n    return function handleResendCode() {\n      return _ref3.apply(this, arguments);\n    };\n  }();\n  return /*#__PURE__*/React.createElement(\"div\", {\n    className: \"mfa-step\"\n  }, /*#__PURE__*/React.createElement(\"div\", {\n    className: \"mfa-header\"\n  }, /*#__PURE__*/React.createElement(\"h2\", null, \"Verificaci\\xF3n en dos pasos\"), /*#__PURE__*/React.createElement(\"p\", null, \"Ingresa el c\\xF3digo de 6 d\\xEDgitos de tu aplicaci\\xF3n de autenticaci\\xF3n\"), /*#__PURE__*/React.createElement(\"p\", {\n    className: \"mfa-username\"\n  }, username)), /*#__PURE__*/React.createElement(\"div\", {\n    className: \"mfa-code-input\"\n  }, code.map(function (digit, index) {\n    return /*#__PURE__*/React.createElement(\"input\", {\n      key: index,\n      ref: function ref(el) {\n        return inputRefs.current[index] = el;\n      },\n      type: \"text\",\n      inputMode: \"numeric\",\n      maxLength: \"1\",\n      value: digit,\n      onChange: function onChange(e) {\n        return handleInputChange(index, e.target.value);\n      },\n      onKeyDown: function onKeyDown(e) {\n        return handleKeyDown(index, e);\n      },\n      onPaste: handlePaste,\n      disabled: isLoading || timer === 0,\n      className: \"mfa-digit-input\",\n      autoComplete: \"one-time-code\"\n    });\n  })), error && /*#__PURE__*/React.createElement(\"div\", {\n    className: \"error-message\"\n  }, error), /*#__PURE__*/React.createElement(\"div\", {\n    className: \"mfa-timer\"\n  }, /*#__PURE__*/React.createElement(\"p\", null, \"C\\xF3digo v\\xE1lido por: \", formatTime(timer))), /*#__PURE__*/React.createElement(\"div\", {\n    className: \"mfa-actions\"\n  }, /*#__PURE__*/React.createElement(\"button\", {\n    type: \"button\",\n    className: \"btn-secondary\",\n    onClick: handleResendCode,\n    disabled: isLoading || timer > 240\n  }, \"Reenviar c\\xF3digo\"), /*#__PURE__*/React.createElement(\"button\", {\n    type: \"button\",\n    className: \"btn-secondary\",\n    onClick: onCancel,\n    disabled: isLoading\n  }, \"Cancelar\")), /*#__PURE__*/React.createElement(\"div\", {\n    className: \"mfa-help\"\n  }, /*#__PURE__*/React.createElement(\"p\", null, \"\\xBFNo recibiste el c\\xF3digo? Verifica tu aplicaci\\xF3n de autenticaci\\xF3n.\")));\n};\nexport default MFAStep;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}